@page "/seller/cases/{caseId:int}"
@model SD.ProjectName.WebApp.Pages.Seller.Cases.DetailsModel
@using SD.ProjectName.Modules.Cart.Domain
@{
    ViewData["Title"] = "Case details";
    var request = Model.Case!;
    var sellerOrder = Model.SellerOrder;
    var order = Model.Order;
}

<div class="d-flex align-items-center gap-3 mb-3">
    <h1 class="mb-0">Case #@request.Id</h1>
    <span class="badge @Model.GetCaseBadgeClass(request.Status) text-uppercase">@Model.GetCaseStatusLabel(request.Status, request.Resolution)</span>
</div>

<div class="mb-3 d-flex gap-3 align-items-center">
    <a class="btn btn-link p-0" asp-page="/Seller/Cases/Index">Back to cases</a>
    @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
    {
        <span class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1">@Model.StatusMessage</span>
    }
    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-2 py-1">@Model.ErrorMessage</span>
    }
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-3">
            <div class="card-body">
                <div class="row gy-2">
                    <div class="col-md-6">
                        <div class="text-muted">Type</div>
                        <div class="fw-semibold">@Model.GetCaseTypeLabel(request.RequestType)</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted">Created</div>
                        <div class="fw-semibold">@request.RequestedAt.ToLocalTime().ToString("f")</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted">Order</div>
                        <div>
                            <a asp-page="/Seller/Orders/Details" asp-route-sellerOrderId="@request.SellerOrderId">Order #@request.OrderId</a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted">Buyer</div>
                        <div>@Model.GetBuyerAlias()</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted">Current status</div>
                        <div class="fw-semibold">@Model.GetCaseStatusLabel(request.Status, request.Resolution)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Buyer request</div>
            <div class="card-body">
                <div class="mb-2">
                    <div class="text-muted">Reason</div>
                    <div class="fw-semibold">@request.Reason</div>
                </div>
                @if (!string.IsNullOrWhiteSpace(request.Description))
                {
                    <div class="mb-2">
                        <div class="text-muted">Description</div>
                        <div>@request.Description</div>
                    </div>
                }
                <div class="mb-2">
                    <div class="text-muted">Items</div>
                    @if (request.Items?.Any() == true)
                    {
                        <ul class="mb-0">
                            @foreach (var item in request.Items)
                            {
                                var itemName = item.OrderItem?.ProductName ?? $"Item #{item.OrderItemId}";
                                <li>@itemName (x@item.Quantity)</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-muted">No items recorded.</div>
                    }
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Resolution</div>
            <div class="card-body">
                <div class="mb-2">
                    <div class="text-muted small">Current status</div>
                    <div class="fw-semibold">@Model.GetCaseStatusLabel(request.Status, request.Resolution)</div>
                </div>
                @if (!string.IsNullOrWhiteSpace(request.Resolution))
                {
                    <div class="mb-2">
                        <div class="text-muted small">Decision</div>
                        <div class="fw-semibold">@Model.GetResolutionLabel(request)</div>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(request.ResolutionNote))
                {
                    <div class="mb-2">
                        <div class="text-muted small">Note to buyer</div>
                        <div>@request.ResolutionNote</div>
                    </div>
                }
                @if (ReturnRequestWorkflow.RequiresRefund(request.Resolution ?? string.Empty) || request.RefundAmount.HasValue || !string.IsNullOrWhiteSpace(request.RefundStatus))
                {
                    <div class="mb-2">
                        <div class="text-muted small">Refund</div>
                        <div class="fw-semibold">@Model.GetRefundStatusLabel(request)</div>
                        @if (request.RefundAmount.HasValue)
                        {
                            <div>Amount: @request.RefundAmount.Value.ToString("C")</div>
                        }
                        @if (!string.IsNullOrWhiteSpace(request.RefundReference))
                        {
                            <div class="text-muted small">Reference: <span class="text-monospace">@request.RefundReference</span></div>
                        }
                    </div>
                }
                @if (request.UpdatedAt.HasValue)
                {
                    <div class="text-muted small">Last updated @request.UpdatedAt.Value.ToLocalTime().ToString("g")</div>
                }
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">Order &amp; shipping</div>
            <div class="card-body">
                <div class="mb-2">
                    <div class="text-muted small">Sub-order status</div>
                    <div class="fw-semibold text-capitalize">@OrderStatusFlow.NormalizeStatus(sellerOrder?.Status ?? OrderStatus.New)</div>
                </div>
                @if (sellerOrder?.ShippingSelection is not null)
                {
                    <div class="mb-2">
                        <div class="text-muted small">Shipping method</div>
                        <div>@sellerOrder.ShippingSelection.ShippingMethod (@sellerOrder.ShippingTotal.ToString("C"))</div>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(sellerOrder?.TrackingNumber))
                {
                    <div class="mb-2">
                        <div class="text-muted small">Tracking</div>
                        <div>
                            @sellerOrder!.TrackingNumber
                            @if (!string.IsNullOrWhiteSpace(sellerOrder.TrackingCarrier))
                            {
                                <span class="text-muted ms-1">(@sellerOrder.TrackingCarrier)</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(sellerOrder.TrackingUrl))
                            {
                                <a class="ms-2" href="@sellerOrder.TrackingUrl" target="_blank" rel="noopener noreferrer">Open</a>
                            }
                        </div>
                    </div>
                }
                @if (order is not null)
                {
                    <div class="mb-2">
                        <div class="text-muted small">Delivery address</div>
                        <div>@order.DeliveryRecipientName</div>
                        <div>@order.DeliveryLine1</div>
                        @if (!string.IsNullOrWhiteSpace(order.DeliveryLine2))
                        {
                            <div>@order.DeliveryLine2</div>
                        }
                        <div>@order.DeliveryPostalCode @order.DeliveryCity</div>
                        <div>@order.DeliveryRegion, @order.DeliveryCountryCode</div>
                    </div>
                }
            </div>
        </div>

        <div class="card">
            <div class="card-header">Case messaging</div>
            <div class="list-group list-group-flush">
                @if (Model.Thread.Any())
                {
                    @foreach (var message in Model.Thread)
                    {
                        <div class="list-group-item">
                            <div class="fw-semibold">@Model.GetSenderLabel(message)</div>
                            <div class="text-muted small">@message.CreatedAt.ToLocalTime().ToString("g")</div>
                            <div>@message.Body</div>
                        </div>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">No messages yet.</div>
                }
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="Message" class="d-flex flex-column gap-2">
                    <div>
                        <label asp-for="MessageBody" class="form-label">New message to buyer</label>
                        <textarea asp-for="MessageBody" class="form-control" rows="3" maxlength="4000"></textarea>
                        <span asp-validation-for="MessageBody" class="text-danger"></span>
                        <div class="form-text">Share updates or requests; avoid asking for personal contact details.</div>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">Send message</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">Actions</div>
            <div class="card-body">
                @if (Model.CanTakeAction)
                {
                    <form method="post" asp-page-handler="Decide" class="d-flex flex-column gap-3">
                        <input type="hidden" name="caseId" value="@request.Id" />
                        <div>
                            <div class="form-label fw-semibold mb-1">Select resolution</div>
                            <div class="d-flex flex-column gap-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" asp-for="ResolutionOption" id="resolution-full-refund" value="@ReturnRequestResolution.FullRefund" />
                                    <label class="form-check-label fw-semibold" for="resolution-full-refund">Full refund</label>
                                    <div class="form-text">Refund the remaining balance for this seller order.</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" asp-for="ResolutionOption" id="resolution-partial-refund" value="@ReturnRequestResolution.PartialRefund" />
                                    <label class="form-check-label fw-semibold" for="resolution-partial-refund">Partial refund</label>
                                    <div class="form-text">Specify the amount below.</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" asp-for="ResolutionOption" id="resolution-replacement" value="@ReturnRequestResolution.Replacement" />
                                    <label class="form-check-label fw-semibold" for="resolution-replacement">Replacement</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" asp-for="ResolutionOption" id="resolution-repair" value="@ReturnRequestResolution.Repair" />
                                    <label class="form-check-label fw-semibold" for="resolution-repair">Repair</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" asp-for="ResolutionOption" id="resolution-no-refund" value="@ReturnRequestResolution.NoRefund" />
                                    <label class="form-check-label fw-semibold" for="resolution-no-refund">No refund / reject</label>
                                    <div class="form-text">Add a reason for the buyer.</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label asp-for="ResolutionRefundAmount" class="form-label">Refund amount</label>
                            <input asp-for="ResolutionRefundAmount" class="form-control" type="number" min="0" step="0.01" />
                            <div class="form-text">Required for partial refund. Leave blank for full refund to use the outstanding balance.</div>
                        </div>
                        <div class="form-check">
                            <input asp-for="LinkExistingRefund" class="form-check-input" type="checkbox" id="link-existing-refund" />
                            <label class="form-check-label" for="link-existing-refund">Refund already processed externally</label>
                            <div class="form-text">We will record the reference instead of initiating a refund now.</div>
                        </div>
                        <div>
                            <label asp-for="RefundReference" class="form-label">Refund reference</label>
                            <input asp-for="RefundReference" class="form-control" />
                            <div class="form-text">Provide the payment or refund reference (required when linking an existing refund).</div>
                        </div>
                        <div>
                            <label asp-for="ResolutionNote" class="form-label">Resolution note</label>
                            <textarea asp-for="ResolutionNote" class="form-control" rows="3"></textarea>
                            <div class="form-text">This will be shared with the buyer. Explain partial or no-refund decisions.</div>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-sm btn-primary">Confirm resolution</button>
                            <div class="text-muted small mt-1">Actions are recorded and the buyer will be notified.</div>
                        </div>
                    </form>
                }
                else
                {
                    <div class="text-muted">No further actions available for this case.</div>
                }
            </div>
        </div>

        <div class="card">
            <div class="card-header">Buyer context</div>
            <div class="card-body">
                <div class="mb-2">
                    <div class="text-muted small">Buyer alias</div>
                    <div>@Model.GetBuyerAlias()</div>
                </div>
                <div class="mb-2">
                    <div class="text-muted small">Payment method</div>
                    <div>@(order?.PaymentMethod ?? "Not specified")</div>
                </div>
            </div>
        </div>
    </div>
</div>
